<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dana AI - Slack Dashboard</title>
    <link rel="stylesheet" href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css">
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        .message-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .feather {
            width: 16px;
            height: 16px;
            vertical-align: text-bottom;
        }
        .slack-timestamp {
            font-size: 0.8rem;
            color: var(--bs-secondary-color);
        }
        .slack-message {
            border-left: 3px solid var(--bs-primary);
            padding-left: 10px;
            margin-bottom: 15px;
        }
        .status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <header class="pb-3 mb-4 border-bottom">
            <div class="d-flex align-items-center text-white">
                <i data-feather="message-square" class="me-2"></i>
                <span class="fs-4">Slack Integration Dashboard</span>
            </div>
        </header>

        <div class="row">
            <!-- Connection Status -->
            <div class="col-md-4">
                <div class="card mb-4 position-relative">
                    <div class="card-header">
                        <h5 class="mb-0">Connection Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="status-badge">
                            <span id="connection-status-badge" class="badge bg-secondary">Checking...</span>
                        </div>
                        <h6 class="card-title">Slack Integration</h6>
                        <div id="connection-details">
                            <p class="placeholder-glow">
                                <span class="placeholder col-7"></span>
                                <span class="placeholder col-4"></span>
                                <span class="placeholder col-4"></span>
                                <span class="placeholder col-6"></span>
                            </p>
                        </div>
                        <button id="check-connection" class="btn btn-primary">
                            <i data-feather="refresh-cw" class="feather me-1"></i> Check Connection
                        </button>
                    </div>
                </div>
            </div>

            <!-- Send Message -->
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Send Message</h5>
                    </div>
                    <div class="card-body">
                        <form id="send-message-form">
                            <div class="mb-3">
                                <label for="message" class="form-label">Message</label>
                                <textarea class="form-control" id="message" rows="3" placeholder="Enter your message here..."></textarea>
                            </div>
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="use-formatting">
                                <label class="form-check-label" for="use-formatting">Use rich formatting</label>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i data-feather="send" class="feather me-1"></i> Send Message
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Recent Messages -->
            <div class="col-md-12">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Recent Messages</h5>
                        <button id="refresh-messages" class="btn btn-sm btn-secondary">
                            <i data-feather="refresh-cw" class="feather me-1"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="messages-container" class="message-container">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading messages...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification Test -->
        <div class="row">
            <div class="col-md-12">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Test Notifications</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title">User Notifications</h6>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-outline-primary btn-sm test-notification" data-type="user" data-subtype="signup">
                                                Test Signup
                                            </button>
                                            <button class="btn btn-outline-primary btn-sm test-notification" data-type="user" data-subtype="login">
                                                Test Login
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title">Subscription Notifications</h6>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-outline-primary btn-sm test-notification" data-type="subscription" data-subtype="new_subscription">
                                                Test New Subscription
                                            </button>
                                            <button class="btn btn-outline-primary btn-sm test-notification" data-type="subscription" data-subtype="subscription_cancelled">
                                                Test Cancellation
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title">System Notifications</h6>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-outline-primary btn-sm test-notification" data-type="system" data-subtype="status">
                                                Test Status Update
                                            </button>
                                            <button class="btn btn-outline-warning btn-sm test-notification" data-type="system" data-subtype="warning">
                                                Test Warning
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="resultModalLabel">Operation Result</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="result-content">
                    <!-- Result content will be inserted here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize Feather icons
        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
            checkConnection();
            loadMessages();
        });

        // Modal instance
        let resultModal;

        // Initialize Bootstrap components
        document.addEventListener('DOMContentLoaded', () => {
            resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
        });

        // Show result in modal
        function showResult(title, content, isSuccess = true) {
            const modalTitle = document.getElementById('resultModalLabel');
            const resultContent = document.getElementById('result-content');
            
            modalTitle.textContent = title;
            
            let resultHtml = '';
            if (isSuccess) {
                resultHtml = `<div class="alert alert-success">${content}</div>`;
            } else {
                resultHtml = `<div class="alert alert-danger">${content}</div>`;
            }
            
            if (typeof content === 'object') {
                resultHtml += `<pre class="mt-3 bg-dark text-light p-3 rounded"><code>${JSON.stringify(content, null, 2)}</code></pre>`;
            }
            
            resultContent.innerHTML = resultHtml;
            resultModal.show();
        }

        // Check Slack connection
        async function checkConnection() {
            const statusBadge = document.getElementById('connection-status-badge');
            const connectionDetails = document.getElementById('connection-details');
            
            try {
                statusBadge.className = 'badge bg-info';
                statusBadge.textContent = 'Checking...';
                
                const response = await fetch('/api/slack/status');
                const data = await response.json();
                
                if (data.valid) {
                    statusBadge.className = 'badge bg-success';
                    statusBadge.textContent = 'Connected';
                    
                    connectionDetails.innerHTML = `
                        <p><strong>Channel ID:</strong> ${data.channel_id}</p>
                        <p><strong>Bot Token:</strong> <span class="text-success">Configured</span></p>
                        <p class="text-success mb-0"><i data-feather="check-circle"></i> Ready to use</p>
                    `;
                    feather.replace();
                } else {
                    statusBadge.className = 'badge bg-danger';
                    statusBadge.textContent = 'Disconnected';
                    
                    let missingText = '';
                    if (data.missing && data.missing.length) {
                        missingText = `<p class="text-danger">Missing environment variables: ${data.missing.join(', ')}</p>`;
                    }
                    
                    connectionDetails.innerHTML = `
                        ${missingText}
                        <p class="text-danger mb-0"><i data-feather="alert-circle"></i> Not configured properly</p>
                    `;
                    feather.replace();
                }
            } catch (error) {
                statusBadge.className = 'badge bg-danger';
                statusBadge.textContent = 'Error';
                
                connectionDetails.innerHTML = `
                    <p class="text-danger"><i data-feather="alert-triangle"></i> Failed to check connection</p>
                    <p class="text-secondary">${error.message}</p>
                `;
                feather.replace();
            }
        }

        // Load recent messages
        async function loadMessages() {
            const messagesContainer = document.getElementById('messages-container');
            
            try {
                const response = await fetch('/api/slack/history');
                const data = await response.json();
                
                if (data.success && data.messages && data.messages.length) {
                    let messagesHtml = '';
                    
                    data.messages.forEach(message => {
                        messagesHtml += `
                            <div class="slack-message">
                                <div class="d-flex justify-content-between">
                                    <strong>${message.user || 'Unknown User'}</strong>
                                    <span class="slack-timestamp">${message.timestamp}</span>
                                </div>
                                <p>${message.text}</p>
                            </div>
                        `;
                    });
                    
                    messagesContainer.innerHTML = messagesHtml;
                } else {
                    messagesContainer.innerHTML = `
                        <div class="text-center py-5">
                            <i data-feather="message-square" style="width: 48px; height: 48px; color: var(--bs-secondary);"></i>
                            <p class="mt-2">No messages found</p>
                        </div>
                    `;
                    feather.replace();
                }
            } catch (error) {
                messagesContainer.innerHTML = `
                    <div class="text-center py-5">
                        <i data-feather="alert-circle" style="width: 48px; height: 48px; color: var(--bs-danger);"></i>
                        <p class="mt-2 text-danger">Failed to load messages</p>
                        <p class="text-secondary">${error.message}</p>
                    </div>
                `;
                feather.replace();
            }
        }

        // Send a message
        async function sendMessage(message, useFormatting) {
            try {
                const requestBody = {
                    message: message
                };
                
                if (useFormatting) {
                    // Add some simple Slack formatting
                    requestBody.blocks = [
                        {
                            "type": "section",
                            "text": {
                                "type": "mrkdwn",
                                "text": message
                            }
                        },
                        {
                            "type": "context",
                            "elements": [
                                {
                                    "type": "mrkdwn",
                                    "text": `Sent from Dana AI Dashboard at ${new Date().toLocaleString()}`
                                }
                            ]
                        }
                    ];
                }
                
                const response = await fetch('/api/slack/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showResult('Message Sent', 'Your message was sent successfully to Slack!', true);
                    // Refresh messages list
                    setTimeout(loadMessages, 1000);
                } else {
                    showResult('Error', `Failed to send message: ${data.message}`, false);
                }
            } catch (error) {
                showResult('Error', `Failed to send message: ${error.message}`, false);
            }
        }

        // Test notification
        async function testNotification(type, subtype) {
            try {
                let endpoint = '';
                let requestBody = {};
                
                if (type === 'user') {
                    endpoint = '/api/slack/test/user-notification';
                    
                    if (subtype === 'signup') {
                        requestBody = {
                            notification_type: 'signup',
                            data: {
                                email: 'test@example.com',
                                company: 'Test Company'
                            }
                        };
                    } else if (subtype === 'login') {
                        requestBody = {
                            notification_type: 'login',
                            data: {
                                email: 'test@example.com'
                            }
                        };
                    }
                } else if (type === 'subscription') {
                    endpoint = '/api/slack/test/subscription-notification';
                    
                    if (subtype === 'new_subscription') {
                        requestBody = {
                            notification_type: 'new_subscription',
                            data: {
                                user_id: '12345',
                                tier_name: 'Professional',
                                payment_method: 'Credit Card'
                            }
                        };
                    } else if (subtype === 'subscription_cancelled') {
                        requestBody = {
                            notification_type: 'subscription_cancelled',
                            data: {
                                user_id: '12345',
                                tier_name: 'Professional',
                                reason: 'Switching to different plan'
                            }
                        };
                    }
                } else if (type === 'system') {
                    endpoint = '/api/slack/test/system-notification';
                    
                    if (subtype === 'status') {
                        requestBody = {
                            notification_type: 'status',
                            data: {
                                message: 'System update completed successfully',
                                status_type: 'success',
                                details: {
                                    'Duration': '5 minutes',
                                    'Components Updated': 'Database, API Server',
                                    'Version': '1.2.3'
                                }
                            }
                        };
                    } else if (subtype === 'warning') {
                        requestBody = {
                            notification_type: 'warning',
                            data: {
                                message: 'High CPU usage detected',
                                location: 'API Server'
                            }
                        };
                    }
                }
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showResult('Notification Sent', `${type.charAt(0).toUpperCase() + type.slice(1)} notification (${subtype}) was sent successfully!`, true);
                    // Refresh messages list
                    setTimeout(loadMessages, 1000);
                } else {
                    showResult('Error', `Failed to send notification: ${data.message}`, false);
                }
            } catch (error) {
                showResult('Error', `Failed to send notification: ${error.message}`, false);
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Check connection button
            document.getElementById('check-connection').addEventListener('click', checkConnection);
            
            // Refresh messages button
            document.getElementById('refresh-messages').addEventListener('click', loadMessages);
            
            // Send message form
            document.getElementById('send-message-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const messageInput = document.getElementById('message');
                const useFormatting = document.getElementById('use-formatting').checked;
                
                if (messageInput.value.trim()) {
                    sendMessage(messageInput.value, useFormatting);
                    messageInput.value = '';
                }
            });
            
            // Test notification buttons
            document.querySelectorAll('.test-notification').forEach(button => {
                button.addEventListener('click', function() {
                    const type = this.dataset.type;
                    const subtype = this.dataset.subtype;
                    testNotification(type, subtype);
                });
            });
        });
    </script>
</body>
</html>